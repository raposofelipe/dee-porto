---
title: "R Notebook"
output: html_notebook
---

# 1. Leitura

```{r}
library(tidyverse)
```

```{r}
df_carga <- readRDS("S:/CECAN/Felipe Raposo/NCM - Porto/2. data/[porto] df_carga.rds")# base principal
comex <- readRDS("S:/CECAN/Felipe Raposo/NCM - Porto/2. data/[porto] comex_quasilimpo.rds")
```

# 2. Tratamento

```{r}
# Selecionando o que vamos usar
# O porquê da escolha dessas são elaborados mais tarde 
df_carga <- df_carga %>% 
  ungroup() %>% 
  select_at(-c(2:7, 9, 11:12, 16))

# Padronizando nome das variáveis
colnames(df_carga) <- colnames(df_carga) %>% str_to_lower() %>% str_replace_all("[^\\w]", "_") %>%
  stringi::stri_trans_general("Latin-ASCII")
```

```{r warning=FALSE}
# Padronizando texto dos complexos portuários
df_carga <- df_carga %>% 
  mutate(# Pegando os primeiros dois dígitos da ncm
         ncm2 = substr(ncm4, 1, 2)) %>% 
  rename("peso" = vlpesocargabruta)
```

```{r}
df_carga <- df_carga %>% 
  filter(par_completo %in% comex_reduzida$par_completo)
```

```{r}
comex <- comex %>% 
  mutate(NCM4 = as.numeric(NCM4),
         movimentacao = if_else(movimentacao == "exp", 0, 1))
```


## 2.1 Pares sem


```{r}
par_combinacao <- df_carga %>% 
  group_by(natureza_da_carga, par_completo) %>% 
  summarise(n = n(), .groups = "drop") %>% 
  group_by(par_completo, natureza_da_carga) %>% 
  summarise(count = n(), .groups = 'drop') %>% 
  pivot_wider(names_from = natureza_da_carga, values_from = count,
              values_fill = 0)

par_combinacao <- par_combinacao %>% 
  mutate(one_n = rowSums(select(., -par_completo) == 1)) %>% 
  filter(one_n != 1) %>% # isso não faz muuito sentido já que eu já tirei os puros, mas é bom reforçar
  select(-one_n) %>% 
  pivot_longer(cols = -1, 
               names_to = "natureza_da_carga", values_to = "n") %>% 
  filter(n != 0)

# diz qual a combinação de naturezas que temos pra cada par
par_combinacao <- par_combinacao %>% 
  group_by(par_completo) %>%
  summarise(combinacao = paste(sort(unique(natureza_da_carga)), collapse = ", ")) %>% 
  ungroup()
```

```{r}
# transformando em lista
list_combinacao <- par_combinacao %>% 
  group_by(combinacao) %>%
  summarise(pares_completos = list(par_completo)) %>%
  ungroup()

# o que vai virar lixos depois na comex
list_nao_container <- list_combinacao %>% 
  filter(!str_detect(combinacao, "Conteinerizada"))

list_nao_container <- setNames(as.list(list_nao_container$pares_completos), list_nao_container$combinacao)
```

Limpando!

```{r}
comex_reduzida <- comex_reduzida %>% 
  filter(# limpando pares completos!
         !par_completo %in% list_nao_container[[1]],
         !par_completo %in% list_nao_container[[2]],
         !par_completo %in% list_nao_container[[3]])

df_carga <- df_carga %>% 
  filter(# limpando pares completos!
         !par_completo %in% list_nao_container[[1]],
         !par_completo %in% list_nao_container[[2]],
         !par_completo %in% list_nao_container[[3]])
```

## 2.2 Matriz 

Contruindo uma matriz de porcentagem, ou seja, o quanto que aquele par completo tem de cada natureza da carga.

```{r}
matriz <- df_carga %>% 
  group_by(par_completo, natureza_da_carga) %>% 
  summarise(peso_total = sum(peso)) %>% 
  mutate(porcentagem = round(peso_total/sum(peso_total), 3)) %>% 
  select(-peso_total) %>% 
  pivot_wider(names_from = "natureza_da_carga", values_from = "porcentagem", values_fill = 0)
```

CORTE! Pegando só o que tá na meiuca pra classificar

```{r}
matriz_calda <- matriz %>% 
  filter(`Carga Conteinerizada` <= 0.1 | `Carga Conteinerizada` >= 0.9)
```

# 3. Resultado Caldas

```{r}
resultado_dez <- matriz_calda %>% 
  ungroup() %>%
  pivot_longer(cols = -c(1), names_to = "natureza_da_carga", values_to = "porcentagem") %>% 
  group_by(par_completo) %>% 
  filter(porcentagem == max(porcentagem)) %>% ungroup() %>% 
  select_at(-3)

resultado_cinco <- matriz_calda %>% 
  ungroup() %>%
  filter(`Carga Conteinerizada` <= 0.05 | `Carga Conteinerizada` >= 0.95) %>% 
  pivot_longer(cols = -c(1), names_to = "natureza_da_carga", values_to = "porcentagem") %>% 
  group_by(par_completo) %>% 
  filter(porcentagem == max(porcentagem)) %>% ungroup() %>% 
  select_at(-3)

resultado_dois <- matriz_calda %>% 
  ungroup() %>%
  filter(`Carga Conteinerizada` <= 0.025 | `Carga Conteinerizada` >= 0.975) %>%  
  pivot_longer(cols = -c(1), names_to = "natureza_da_carga", values_to = "porcentagem") %>% 
  group_by(par_completo) %>% 
  filter(porcentagem == max(porcentagem)) %>% ungroup() %>% 
  select_at(-3)
```

```{r}
# dez
comex %>% 
  filter(par_completo %in% resultado_dez$par_completo) %>% 
  left_join(resultado_dez, by = "par_completo") %>% 
  reframe(n = n(), 
          peso_total = sum(peso), 
          valor_total = sum(VL_FOB), 
          .by = natureza_da_carga) %>% 
  mutate(porcentagem_observacoes = n/nrow(comex),
         porcentagem_peso = peso_total/sum(comex$peso),
         porcentagem_valor = valor_total/sum(comex$VL_FOB),
         corte = "10%") %>% 
  arrange(natureza_da_carga) %>% 
  
  # cinco
  rbind(comex %>% 
    filter(par_completo %in% resultado_cinco$par_completo) %>% 
    left_join(resultado_cinco, by = "par_completo") %>% 
    reframe(n = n(), 
            peso_total = sum(peso), 
            valor_total = sum(VL_FOB),
            .by = natureza_da_carga) %>% 
    mutate(porcentagem_observacoes = n/nrow(comex),
           porcentagem_peso = peso_total/sum(comex$peso),
           porcentagem_valor = valor_total/sum(comex$VL_FOB),
           corte = "5%") %>% 
    arrange(natureza_da_carga)) %>% 
  
  # dois e meio
  rbind(comex %>%  
    filter(par_completo %in% resultado_dois$par_completo) %>% 
    left_join(resultado_dois, by = "par_completo") %>% 
    reframe(n = n(), 
            peso_total = sum(peso),
            valor_total = sum(VL_FOB), 
            .by = natureza_da_carga) %>% 
    mutate(porcentagem_observacoes = n/nrow(comex),
           porcentagem_peso = peso_total/sum(comex$peso),
           porcentagem_valor = valor_total/sum(comex$VL_FOB),
           corte = "2.5%") %>% 
    arrange(natureza_da_carga)) %>% 
  write_rds("S:/CECAN/Felipe Raposo/NCM - Porto/Dados/[porto] calda_participacao.rds")
```


```{r}
porcentagens <- readRDS("S:/CECAN/Felipe Raposo/NCM - Porto/Dados/[porto] calda_participacao.rds")
```

# 4. Puros

```{r}
ncm_pura <- readxl::read_excel("S:/CECAN/Felipe Raposo/NCM - Porto/Dados/[porto] NCM_PURA.xls")
porto_puro <- readxl::read_excel("S:/CECAN/Felipe Raposo/NCM - Porto/Dados/[porto] PORTO_PURO.xls") 

par_puro <- readxl::read_excel("S:/CECAN/Felipe Raposo/NCM - Porto/Dados/[porto] COMBINACAO_PURA.xls") %>% 
  mutate(NCM4 = as.numeric(NCM4), 
         par_completo = paste(`Complexo Portuário`, NCM4, sep = "_"))
```

# 5. Resultado Final
```{r}
comex %>% 
  filter(par_completo %in% par_puro$par_completo) %>% 
  left_join(par_puro %>% select(`Natureza da Carga`, par_completo), by = "par_completo") %>% 
  rbind(
    comex %>% 
  filter(NCM4 %in% ncm_pura$NCM4) %>% 
  left_join(ncm_pura %>% select(NCM4, `Natureza da Carga`), by = "NCM4")
  ) %>% 
  rename(natureza_da_carga = `Natureza da Carga`) %>% 
  reframe(n = n(), 
          peso_total = sum(peso), 
          valor_total = sum(VL_FOB),
          .by = natureza_da_carga) %>% 
  mutate(porcentagem_observacoes = n/nrow(comex),
         porcentagem_peso = peso_total/sum(comex$peso), 
         porcentagem_valor = valor_total/sum(comex$VL_FOB),
         corte = "puros") %>% 
  group_by(natureza_da_carga,corte) %>% 
  summarise(porcentagem_observacoes = sum(porcentagem_observacoes),
            porcentagem_peso = sum(porcentagem_peso), 
            porcentagem_valor = sum(porcentagem_valor),
            n = sum(n), 
            peso_total = sum(peso_total), 
            valor_total = sum(valor_total), 
            .groups = "drop") %>% 
  rbind(porcentagens) %>% 
  write_rds("S:/CECAN/Felipe Raposo/NCM - Porto/Dados/[porto] cortes_participacao.rds")
```

```{r}
porcentagens_completo <- readRDS("S:/CECAN/Felipe Raposo/NCM - Porto/Dados/[porto] cortes_participacao.rds")
```

```{r}
porcentagens_completo %>% 
  filter(corte %in% c("puros", "10%")) %>% 
  summarise(porcentagem_observacoes = sum(porcentagem_observacoes),
            porcentagem_peso = sum(porcentagem_peso), 
            n = sum(n), 
            peso_total = sum(peso_total)) %>% clipr::write_clip()
```

# 6. Bases de classificados

## 6.1 Base pura
```{r}
comex %>% 
  filter(par_completo %in% par_puro$par_completo) %>% 
  left_join(par_puro %>% select(`Natureza da Carga`, par_completo), by = "par_completo") %>% 
  rbind(
    comex %>% 
  filter(NCM4 %in% ncm_pura$NCM4) %>% 
  left_join(ncm_pura %>% select(NCM4, `Natureza da Carga`), by = "NCM4")
  ) %>% 
  rename(natureza_da_carga = `Natureza da Carga`) %>% 
  write_rds("S:/CECAN/Felipe Raposo/NCM - Porto/Dados/Classificados/[porto] comex_puro.rds")
```

## 6.2 Corte de dois

```{r}
comex %>% 
  filter(par_completo %in% par_puro$par_completo) %>% 
  left_join(par_puro %>% select(`Natureza da Carga`, par_completo), by = "par_completo") %>% 
  rbind(
    comex %>% 
  filter(NCM4 %in% ncm_pura$NCM4) %>% 
  left_join(ncm_pura %>% select(NCM4, `Natureza da Carga`), by = "NCM4")
  ) %>% 
  rename(natureza_da_carga = `Natureza da Carga`) %>% 
  rbind(comex %>% 
          filter(par_completo %in% resultado_dois$par_completo) %>% 
          left_join(resultado_dois, by = join_by(par_completo))) %>% 
  write_rds("S:/CECAN/Felipe Raposo/NCM - Porto/Dados/Classificados/[porto] comex_corte_2.rds")
```

## 6.3 Corte de cinco

```{r}
comex %>% 
  filter(par_completo %in% par_puro$par_completo) %>% 
  left_join(par_puro %>% select(`Natureza da Carga`, par_completo), by = "par_completo") %>% 
  rbind(
    comex %>% 
  filter(NCM4 %in% ncm_pura$NCM4) %>% 
  left_join(ncm_pura %>% select(NCM4, `Natureza da Carga`), by = "NCM4")
  ) %>% 
  rename(natureza_da_carga = `Natureza da Carga`) %>% 
  rbind(comex %>% 
          filter(par_completo %in% resultado_cinco$par_completo) %>% 
          left_join(resultado_cinco, by = join_by(par_completo))) %>% 
  write_rds("S:/CECAN/Felipe Raposo/NCM - Porto/Dados/Classificados/[porto] comex_corte_5.rds")
```

## 6.4 Corte de dez

```{r}
comex %>% 
  filter(par_completo %in% par_puro$par_completo) %>% 
  left_join(par_puro %>% select(`Natureza da Carga`, par_completo), by = "par_completo") %>% 
  rbind(
    comex %>% 
  filter(NCM4 %in% ncm_pura$NCM4) %>% 
  left_join(ncm_pura %>% select(NCM4, `Natureza da Carga`), by = "NCM4")
  ) %>% 
  rename(natureza_da_carga = `Natureza da Carga`) %>% 
  rbind(comex %>% 
          filter(par_completo %in% resultado_dez$par_completo) %>% 
          left_join(resultado_dez, by = join_by(par_completo))) %>% 
  write_rds("S:/CECAN/Felipe Raposo/NCM - Porto/Dados/Classificados/[porto] comex_corte_10.rds")
```

# 7. Estatísticas

```{r}
comex_puro <- readRDS("S:/CECAN/Felipe Raposo/NCM - Porto/Dados/Classificados/[porto] comex_puro.rds")

comex_dois <- readRDS("S:/CECAN/Felipe Raposo/NCM - Porto/Dados/Classificados/[porto] comex_corte_2.rds")

comex_cinco <- readRDS("S:/CECAN/Felipe Raposo/NCM - Porto/Dados/Classificados/[porto] comex_corte_5.rds")

comex_dez <- readRDS("S:/CECAN/Felipe Raposo/NCM - Porto/Dados/Classificados/[porto] comex_corte_10.rds")
```

## 7.1 Cenário 1: Puros

```{r}
comex_puro %>% 
  mutate(valor_peso = as.numeric(VL_FOB)/as.numeric(peso)) %>% 
  filter(peso != 0) %>% 
  summarise(media = mean(valor_peso, na.rm = T),
            mediana = median(valor_peso))
```

## 7.2 Cenário 2: Corte de 2,5%

```{r}
comex_dois %>% 
  mutate(valor_peso = as.numeric(VL_FOB)/as.numeric(peso)) %>% 
  filter(peso != 0) %>% 
  summarise(media = mean(valor_peso), 
            mediana = median(valor_peso))
```

## 7.3 Cenário 3: Corte de 5%

```{r}
comex_cinco %>% 
  mutate(valor_peso = as.numeric(VL_FOB)/as.numeric(peso)) %>% 
  filter(peso != 0) %>% 
  summarise(media = mean(valor_peso), 
            mediana = median(valor_peso))
```

## 7.4 Cenário 4: Corte de 10%

```{r}
comex_dez %>% 
  mutate(valor_peso = as.numeric(VL_FOB)/as.numeric(peso)) %>% 
  filter(peso != 0) %>% 
  summarise(media = mean(valor_peso), 
            mediana = median(valor_peso))
```

```{r}
comex_puro %>% NROW() - (comex_puro %>% filter(natureza_da_carga == "Carga Conteinerizada") %>% NROW())
```

```{r}
comex_dez %>% NROW() - (comex_dez %>% filter(natureza_da_carga == "Carga Conteinerizada") %>% NROW())
```

```{r}
comex_cinco %>% NROW() - (comex_cinco %>% filter(natureza_da_carga == "Carga Conteinerizada") %>% NROW())
```

```{r}
comex_dois %>% NROW() - (comex_dois %>% filter(natureza_da_carga == "Carga Conteinerizada") %>% NROW())
```
